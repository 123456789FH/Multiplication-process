<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تطبيق تعلم جدول الضرب — شهادة إنجاز مشروطة (v3.5)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --brand:#0ea5e9; --accent:#10b981; --ink:#0f172a; }
    *{box-sizing:border-box}
    body{font-family:"Tajawal","Cairo",system-ui,Segoe UI,Roboto;background:linear-gradient(180deg,#e0f2fe,#e6fffa 60%,#ffffff);min-height:100vh}
    .fade-in{animation:fadeIn .5s ease-in}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .bounce{animation:bounce .6s ease-in-out}@keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
    .shake{animation:shake .5s ease-in-out}@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}

    /* Pills */
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;border:1px solid #e2e8f0;background:#f8fafc;font-size:12px}
    .ok{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .no{background:#fff7ed;border-color:#fed7aa;color:#9a3412}

    /* Explanation overlay */
    .explain-overlay{position:fixed;inset:0;background:rgba(15,23,42,.65);display:none;align-items:center;justify-content:center;z-index:70;padding:16px}
    .explain-card{background:#fff;border-radius:16px;max-width:920px;width:96%;padding:20px;box-shadow:0 20px 50px rgba(2,6,23,.25)}
    .explain-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .explain-badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#f1f5f9;font-weight:700;color:#0f172a}
    .emoji-row{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .emoji{display:inline-block;font-size:22px;margin:2px}
    .legend{display:flex;gap:10px;align-items:center;font-size:13px;color:#334155}
    .legend span.badge{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;border:1px solid #dbeafe;border-radius:999px;padding:4px 8px}

    /* Certificate styles */
    .cert-overlay{position:fixed;inset:0;background:rgba(15,23,42,.65);display:none;align-items:center;justify-content:center;z-index:60;padding:0}
    .cert-sheet{width:297mm;height:210mm;background:#fff;position:relative;border-radius:0;overflow:hidden}
    .cert-bg{position:absolute;inset:0;background:
      radial-gradient(1200px 400px at 90% -10%, rgba(14,165,233,.12), transparent 60%),
      radial-gradient(900px 400px at 10% 110%, rgba(16,185,129,.12), transparent 60%), #fff;}
    .cert-border{position:absolute;inset:10mm;border-radius:10mm;border:6px double rgba(15,23,42,.12);
      box-shadow:inset 0 0 0 10px rgba(14,165,233,.06), inset 0 0 0 20px rgba(16,185,129,.06);}
    .cert-content{position:absolute;inset:0;padding:20mm;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;color:#0f172a}
    .cert-logo{position:absolute;top:16mm;right:20mm;display:flex;gap:10px;align-items:center;font-weight:900}
    .cert-logo .dot{width:14px;height:14px;border-radius:50%;background:var(--brand)}
    .cert-title{margin-top:8mm;font-size:18pt}
    .cert-honor{font-size:44pt;font-weight:900;margin:4mm 0 1mm;background:linear-gradient(90deg,var(--brand),var(--accent));-webkit-background-clip:text;background-clip:text;color:transparent}
    .cert-name{font-size:34pt;font-weight:900;margin:3mm 0 2mm}
    .cert-reason{font-size:14pt;max-width:80%;line-height:1.7;margin-bottom:8mm}
    .cert-meta{display:flex;gap:14mm;flex-wrap:wrap;justify-content:center;font-size:12pt}
    .cert-signs{position:absolute;left:0;right:0;bottom:18mm;display:flex;justify-content:space-between;align-items:center;padding:0 20mm}
    .sig-col{display:flex;flex-direction:column;gap:6px;align-items:center}
    .sig-line{width:80mm;height:1.5px;background:#94a3b8}
    .cert-actions{position:fixed;top:10px;left:10px;z-index:80;display:flex;gap:8px}
    .credit{position:absolute;left:20mm;right:20mm;bottom:6mm;text-align:center;font-size:10pt;color:#64748b}

    /* App footer */
    footer.app{background:#ffffffa6; backdrop-filter: blur(6px); border-top:1px solid #e2e8f0}
    footer.app p{color:#334155}
    footer.app .dot{width:6px;height:6px;border-radius:999px;background:#94a3b8;display:inline-block;margin:0 8px}

    /* Buttons (added) */
    .btn{display:inline-flex;align-items:center;gap:8px;border-radius:10px;padding:8px 14px;border:1px solid #e2e8f0;background:#f8fafc;color:#0f172a;font-weight:700}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn:hover{filter:brightness(0.98)}
    .btn.primary:hover{filter:brightness(0.95)}

    /* Toast (added) */
    .toast-wrap{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);z-index:90;display:flex;flex-direction:column;gap:8px;align-items:center}
    .toast{border-radius:999px;padding:10px 14px;font-weight:700;box-shadow:0 8px 20px rgba(2,6,23,.2);border:1px solid transparent}
    .toast.ok{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .toast.warn{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    .toast.fade{animation:fadeOut 2s forwards}
    @keyframes fadeOut{0%{opacity:1}80%{opacity:1}100%{opacity:0}}

    /* Print */
    @page { size: A4 landscape; margin: 0; }
    @media print{
      .no-print{display:none !important}
      body{background:#fff}
      .cert-overlay{display:block !important;background:transparent !important}
      .cert-sheet{box-shadow:none}
    }
  </style>
</head>
<body>
  <div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <header class="text-center mb-8">
      <div class="mb-4">
        <img src="https://j.top4top.io/p_3581mqu6i1.png" alt="شعار التطبيق" class="mx-auto h-20 w-auto"
             onerror="this.src=''; this.alt='فشل تحميل الشعار'; this.style.display='none';">
      </div>
      <h1 class="text-4xl font-extrabold text-sky-900 mb-2">🧮 تطبيق تعلم جدول الضرب</h1>
      <p class="text-sky-700 text-lg">تعلم الضرب بطريقة ممتعة وتفاعلية!</p>
    </header>

    <!-- Main Menu -->
    <div id="mainMenu" class="max-w-4xl mx-auto">
      <div class="bg-white/90 rounded-2xl shadow-2xl p-8 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">اختر المستوى</h2>
        <div class="grid md:grid-cols-3 gap-6">
          <button onclick="selectLevel(1)"
                  class="bg-emerald-500 hover:bg-emerald-600 text-white p-6 rounded-xl transition-all duration-300 transform hover:scale-105">
            <div class="text-4xl mb-2">🌟</div>
            <h3 class="text-xl font-bold mb-1">المستوى الأول</h3>
            <p class="text-sm opacity-90">جدول الضرب في 1</p>
          </button>
          <button onclick="selectLevel(2)"
                  class="bg-amber-500 hover:bg-amber-600 text-white p-6 rounded-xl transition-all duration-300 transform hover:scale-105">
            <div class="text-4xl mb-2">⭐</div>
            <h3 class="text-xl font-bold mb-1">المستوى الثاني</h3>
            <p class="text-sm opacity-90">جدول الضرب في 2</p>
          </button>
          <button onclick="selectLevel(3)"
                  class="bg-rose-500 hover:bg-rose-600 text-white p-6 rounded-xl transition-all duration-300 transform hover:scale-105">
            <div class="text-4xl mb-2">🏆</div>
            <h3 class="text-xl font-bold mb-1">المستوى الثالث</h3>
            <p class="text-sm opacity-90">جدول الضرب في 3</p>
          </button>
        </div>
      </div>
    </div>

    <!-- Game Mode -->
    <div id="gameModeSelection" class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl p-8 hidden">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">بيانات المتعلم/ـة ثم اختر نوع التمرين</h2>
      <div class="grid md:grid-cols-3 gap-4 mb-6">
        <div>
          <label class="block text-sm font-bold mb-1 text-gray-700">الاسم *</label>
          <input id="studentName" class="w-full border rounded-lg px-3 py-2" placeholder="مثال: نورة / سعد"/>
        </div>
        <div>
          <label class="block text-sm font-bold mb-1 text-gray-700">الشعبة (اختياري)</label>
          <input id="studentSection" class="w-full border rounded-lg px-3 py-2" placeholder="مثال: 3/ب"/>
        </div>
        <div>
          <label class="block text-sm font-bold mb-1 text-gray-700">المعلم/المعلمة (اختياري)</label>
          <input id="teacherName" class="w-full border rounded-lg px-3 py-2" placeholder="مثال: أ/ فاطمة هزازي أو أ/ أحمد"/>
        </div>
      </div>
      <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
        <button onclick="startGame('basic')" class="bg-sky-500 hover:bg-sky-600 text-white p-4 rounded-xl transition-all duration-300">
          <div class="text-3xl mb-2">🔢</div><h4 class="font-bold">أسئلة أساسية</h4>
        </button>
        <button onclick="startGame('word')" class="bg-purple-500 hover:bg-purple-600 text-white p-4 rounded-xl transition-all duration-300">
          <div class="text-3xl mb-2">📝</div><h4 class="font-bold">مسائل لفظية</h4>
        </button>
        <button onclick="startGame('truefalse')" class="bg-orange-500 hover:bg-orange-600 text-white p-4 rounded-xl transition-all duration-300">
          <div class="text-3xl mb-2">✅</div><h4 class="font-bold">صح أم خطأ</h4>
        </button>
        <button onclick="startGame('matching')" class="bg-teal-500 hover:bg-teal-600 text-white p-4 rounded-xl transition-all duration-300">
          <div class="text-3xl mb-2">🔗</div><h4 class="font-bold">مطابقة</h4>
        </button>
      </div>

      <!-- Level 1 certificate status -->
      <div class="mt-6 text-center text-sm text-gray-600" id="level1Status"></div>

      <button onclick="showMainMenu()" class="mt-6 bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">العودة للقائمة الرئيسية</button>
    </div>

    <!-- Game Area -->
    <div id="gameArea" class="max-w-4xl mx-auto hidden">
      <div class="bg-white rounded-xl p-4 mb-4">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-700">التقدم</span>
          <span class="text-sm font-medium text-gray-700"><span id="currentQuestion">١</span> من <span id="totalQuestions">١٠</span></span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
          <div id="progressBar" class="bg-sky-500 h-3 rounded-full transition-all duration-300" style="width:0%"></div>
        </div>
        <div class="flex flex-wrap gap-3 items-center mt-2 text-sm">
          <span class="text-emerald-700">النقاط: <span id="score">٠</span></span>
          <span class="text-sky-700">المستوى: <span id="currentLevel">١</span></span>
          <span class="text-gray-700">النمط: <span id="modeLabel">—</span></span>
          <span class="ml-auto text-gray-600 hidden md:inline" id="level1Pills"></span>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow-2xl p-8 mb-6">
        <div id="questionContent" class="text-center"></div>
      </div>
      <div class="text-center">
        <button onclick="showGameModes()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg ml-2">العودة لاختيار التمرين</button>
        <button onclick="showMainMenu()" class="bg-rose-500 hover:bg-rose-600 text-white px-6 py-2 rounded-lg">القائمة الرئيسية</button>
      </div>
    </div>

    <!-- Results Modal -->
    <div id="resultsModal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50">
      <div class="bg-white rounded-2xl p-8 max-w-md mx-4 w-full fade-in">
        <div class="text-center">
          <div id="resultIcon" class="text-6xl mb-4">🎉</div>
          <h3 class="text-2xl font-bold mb-2" id="resultTitle">أحسنت!</h3>
          <p class="text-gray-600 mb-4" id="resultMessage">لقد أكملت التمرين بنجاح!</p>
          <div class="bg-gray-100 rounded-lg p-4 mb-4">
            <p class="text-lg">النقاط النهائية: <span class="font-bold text-sky-700" id="finalScore">٠</span></p>
            <p class="text-sm text-gray-600">من أصل <span id="maxScore">١٠٠</span> نقطة</p>
          </div>

          <!-- Certificate hint / button -->
          <div id="certHint" class="text-sm text-gray-600 mb-4"></div>
          <button id="certBtn" onclick="openCertificate(true)" class="hidden bg-emerald-500 hover:bg-emerald-600 text-white py-2 px-4 rounded-lg w-full">طباعة شهادة إنجاز المستوى ١</button>

          <div class="flex gap-3 mt-4">
            <button onclick="restartGame()" class="flex-1 bg-sky-500 hover:bg-sky-600 text-white py-2 px-4 rounded-lg">إعادة التمرين</button>
            <button onclick="closeResults()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg">إغلاق</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Explanation Overlay -->
  <div id="explainOverlay" class="explain-overlay no-print" aria-hidden="true">
    <div class="explain-card">
      <div class="flex items-center justify-between mb-3">
        <div class="explain-badge" id="explainBadge">لنَفهم معًا</div>
        <div class="flex gap-2">
          <button class="btn" onclick="closeExplain()">إغلاق</button>
          <button class="btn primary" onclick="goNextFromExplain()">التالي ←</button>
        </div>
      </div>
      <div id="explainText" class="text-lg font-bold text-gray-800 mb-3"></div>
      <div class="explain-grid">
        <div>
          <h4 class="font-semibold text-gray-700 mb-2">تفسير بالجمع المتكرر</h4>
          <div id="explainSum" class="text-gray-800"></div>
          <div id="explainEmoji" class="mt-2"></div>
          <div class="legend mt-2"><span class="badge"><span>🧩</span> كل صف = مجموعة</span> <span class="badge"><span>🔢</span> عدد العناصر = المضروب الثاني</span></div>
        </div>
        <div>
          <h4 class="font-semibold text-gray-700 mb-2">رسم صفوف × أعمدة</h4>
          <div id="explainSVG" class="border rounded-lg p-2"></div>
        </div>
      </div>
      <div id="explainFooter" class="mt-4 text-sm text-gray-600"></div>
    </div>
  </div>

  <!-- Certificate Overlay -->
  <div id="certOverlay" class="cert-overlay" aria-hidden="true">
    <div class="cert-actions no-print">
      <button class="btn" onclick="closeCertificate()">إغلاق</button>
      <button class="btn primary" onclick="window.print()">طباعة / PDF</button>
    </div>
    <section id="certificate" class="cert-sheet" aria-label="شهادة إنجاز قابلة للطباعة">
      <div class="cert-bg"></div>
      <div class="cert-border"></div>
      <div class="cert-content">
        <div class="cert-logo"><span class="dot"></span><span>منصة ملتقى معلمي ومعلمات الرياضيات</span></div>
        <div class="cert-title">تشهد منصة <b>ملتقى معلمي ومعلمات الرياضيات</b> بمنح</div>
        <div class="cert-honor">شهادة إنجاز</div>
        <div class="text-gray-700 mb-1">للطلاب/الطالبات</div>
        <div class="cert-name" id="certName">—</div>
        <div class="cert-reason" id="certReason">—</div>
        <div class="cert-meta">
          <div><b>المستوى:</b> <span id="cLevel">—</span></div>
          <div><b>النمط:</b> <span id="cMode">—</span></div>
          <div><b>النتيجة:</b> <span id="cScore">—</span></div>
          <div><b>التاريخ:</b> <span id="cDate">—</span></div>
          <div><b>رقم الشهادة:</b> <span id="cSerial">—</span></div>
        </div>
        <div class="cert-signs">
          <div class="sig-col"><div class="sig-line"></div><div>مدير/مديرة المدرسة</div></div>
          <div class="sig-col"><div class="sig-line"></div><div id="cTeacher">المعلم/المعلمة</div></div>
        </div>
        <div class="credit">تصميم: <b>أ/ فاطمة هزازي</b> <span class="dot"></span> ملتقى معلمي ومعلمات الرياضيات <span class="dot"></span> ملتقى التعليم التفاعلي</div>
      </div>
    </section>
  </div>

  <!-- App Footer -->
  <footer class="app mt-12 py-6">
    <div class="container mx-auto px-4 text-center">
      <p><b>تصميم:</b> أ/ فاطمة هزازي <span class="dot"></span> ملتقى معلمي ومعلمات الرياضيات <span class="dot"></span> ملتقى التعليم التفاعلي</p>
    </div>
  </footer>

  <!-- Toast container (added) -->
  <div id="toastWrap" class="toast-wrap no-print" aria-live="polite"></div>

  <script>
    // ==== Numerals (Arabic-Indic) ====
    const DIG_MAP = {'0':'٠','1':'١','2':'٢','3':'٣','4':'٤','5':'٥','6':'٦','7':'٧','8':'٨','9':'٩'};
    const REV_MAP = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
    function toArabicDigits(v){ return String(v).replace(/[0-9]/g, d => DIG_MAP[d]); }
    function fromArabicDigits(v){ return String(v).replace(/[٠-٩]/g, d => REV_MAP[d]); }
    function parseNumberLoose(s){ return parseInt(fromArabicDigits(String(s)).replace(/[^0-9\-]/g,''),10); }
    function setTextArabic(sel, val){ const el = (typeof sel==='string') ? document.querySelector(sel) : sel; if (el) el.textContent = toArabicDigits(val); }

    // ==== Config ====
    const MATCH_BEHAVIOR = 'hide'; // 'hide' or 'freeze'
    const AUTO_EXPLAIN_ON_CORRECT = true;
    const EMOJI_DEFAULT = '🔷';
    function emojiFor(text){
      text = (text||'').toLowerCase();
      if (/تفاح|تفاحة/.test(text)) return '🍎';
      if (/قلم/.test(text)) return '✏️';
      if (/كتاب/.test(text)) return '📚';
      if (/كرة/.test(text)) return '⚽️';
      if (/طائر|عصفور/.test(text)) return '🐦';
      if (/صندوق|علبة/.test(text)) return '📦';
      if (/طاولة/.test(text)) return '🪑';
      if (/شجرة/.test(text)) return '🌳';
      return EMOJI_DEFAULT;
    }

    // ==== State ====
    let currentLevel = 1;
    let currentGameMode = 'basic';
    let currentQuestionIndex = 0;
    let score = 0;
    let questions = [];
    let totalQuestions = 10;
    let playerName = '';
    let teacherName = '';
    let playerSection = '';
    let maxScorePoints = 100;
    let explainOpen = false;
    const modeNames = {basic:'أساسية', word:'مسائل لفظية', truefalse:'صح/خطأ', matching:'مطابقة'};

    // Completion tracking (persisted)
    let completions = JSON.parse(localStorage.getItem('mtable_completions') || '{}'); // {player:{level:{mode:true}}}

    function saveCompletions(){ localStorage.setItem('mtable_completions', JSON.stringify(completions)); }
    function markCompleted(player, level, mode){
      completions[player] = completions[player] || {};
      completions[player][level] = completions[player][level] || {};
      completions[player][level][mode] = true;
      saveCompletions();
      updateLevel1StatusRow();
    }
    function isEligibleForCert(player){
      const l1 = (completions[player]||{})['1'] || {};
      return l1.basic && l1.word && l1.truefalse && l1.matching;
    }
    function missingModes(player){
      const m = (completions[player]||{})['1'] || {};
      const need = [];
      if (!m.basic) need.push('أساسية');
      if (!m.word) need.push('لفظية');
      if (!m.truefalse) need.push('صح/خطأ');
      if (!m.matching) need.push('مطابقة');
      return need;
    }

    // ==== DB ====
    const questionDatabase = {
      1:{basic:[{q:"1 × 1 = ?",options:["1","2","0","3"],correct:0},{q:"1 × 2 = ?",options:["1","2","3","4"],correct:1},{q:"1 × 3 = ?",options:["2","3","4","1"],correct:1},{q:"1 × 4 = ?",options:["4","3","2","5"],correct:0},{q:"1 × 5 = ?",options:["4","5","6","3"],correct:1},{q:"1 × 6 = ?",options:["6","5","7","4"],correct:0},{q:"1 × 7 = ?",options:["6","7","8","5"],correct:1},{q:"1 × 8 = ?",options:["8","7","9","6"],correct:0},{q:"1 × 9 = ?",options:["8","9","10","7"],correct:1},{q:"1 × 10 = ?",options:["10","9","11","8"],correct:0}],word:[
        {q:"لديك صندوق واحد، وفي كل صندوق تفاحة واحدة. كم تفاحة لديك؟", options:["1","2","0","3"], correct:0, a:1, b:1},
        {q:"اشترت سارة كيسين، وفي كل كيس قلم واحد. كم قلماً اشترت؟", options:["1","2","3","4"], correct:1, a:2, b:1},
        {q:"في الحديقة 3 أشجار، وعلى كل شجرة طائر واحد. كم طائراً في الحديقة؟", options:["2","3","4","1"], correct:1, a:3, b:1},
        {q:"لدى أحمد 4 علب، وفي كل علبة كرة واحدة. كم كرة لديه؟", options:["4","3","2","5"], correct:0, a:4, b:1},
        {q:"في المكتبة 5 رفوف، وعلى كل رف كتاب واحد. كم كتاباً في المكتبة؟", options:["4","5","6","3"], correct:1, a:5, b:1}
      ],truefalse:[{q:"1 × 3 = 3",correct:true},{q:"1 × 5 = 6",correct:false},{q:"1 × 7 = 7",correct:true},{q:"1 × 2 = 3",correct:false},{q:"1 × 9 = 9",correct:true},{q:"1 × 4 = 5",correct:false},{q:"1 × 6 = 6",correct:true},{q:"1 × 8 = 7",correct:false},{q:"1 × 10 = 10",correct:true},{q:"1 × 1 = 2",correct:false}],matching:[{pairs:[["1 × 1","1"],["1 × 2","2"],["1 × 3","3"],["1 × 4","4"]]},{pairs:[["1 × 5","5"],["1 × 6","6"],["1 × 7","7"],["1 × 8","8"]]},{pairs:[["1 × 9","9"],["1 × 10","10"],["1 × 0","0"],["1 × 11","11"]]}]},
      2:{basic:[{q:"2 × 1 = ?",options:["1","2","3","4"],correct:1},{q:"2 × 2 = ?",options:["3","4","5","2"],correct:1},{q:"2 × 3 = ?",options:["5","6","7","4"],correct:1},{q:"2 × 4 = ?",options:["8","6","7","9"],correct:0},{q:"2 × 5 = ?",options:["9","10","11","8"],correct:1},{q:"2 × 6 = ?",options:["12","10","14","11"],correct:0},{q:"2 × 7 = ?",options:["13","14","15","12"],correct:1},{q:"2 × 8 = ?",options:["16","14","18","15"],correct:0},{q:"2 × 9 = ?",options:["17","18","19","16"],correct:1},{q:"2 × 10 = ?",options:["20","18","22","19"],correct:0}],word:[
        {q:"لديك صندوقان، وفي كل صندوق تفاحتان. كم تفاحة لديك؟", options:["3","4","5","2"], correct:1, a:2, b:2},
        {q:"اشترت فاطمة 3 أكياس، وفي كل كيس قلمان. كم قلماً اشترت؟", options:["5","6","7","4"], correct:1, a:3, b:2},
        {q:"في الصف 4 طاولات، وعلى كل طاولة كتابان. كم كتاباً في الصف؟", options:["8","6","7","9"], correct:0, a:4, b:2},
        {q:"لدى محمد 5 علب، وفي كل علبة كرتان. كم كرة لديه؟", options:["9","10","11","8"], correct:1, a:5, b:2}
      ],truefalse:[{q:"2 × 3 = 6",correct:true},{q:"2 × 5 = 12",correct:false},{q:"2 × 7 = 14",correct:true},{q:"2 × 4 = 9",correct:false},{q:"2 × 9 = 18",correct:true},{q:"2 × 6 = 11",correct:false},{q:"2 × 8 = 16",correct:true},{q:"2 × 2 = 5",correct:false},{q:"2 × 10 = 20",correct:true},{q:"2 × 1 = 3",correct:false}],matching:[{pairs:[["2 × 1","2"],["2 × 2","4"],["2 × 3","6"],["2 × 4","8"]]},{pairs:[["2 × 5","10"],["2 × 6","12"],["2 × 7","14"],["2 × 8","16"]]},{pairs:[["2 × 9","18"],["2 × 10","20"],["2 × 0","0"],["2 × 11","22"]]}]},
      3:{basic:[{q:"3 × 1 = ?",options:["2","3","4","1"],correct:1},{q:"3 × 2 = ?",options:["5","6","7","4"],correct:1},{q:"3 × 3 = ?",options:["8","9","10","7"],correct:1},{q:"3 × 4 = ?",options:["12","10","11","13"],correct:0},{q:"3 × 5 = ?",options:["14","15","16","13"],correct:1},{q:"3 × 6 = ?",options:["18","16","17","19"],correct:0},{q:"3 × 7 = ?",options:["20","21","22","19"],correct:1},{q:"3 × 8 = ?",options:["24","22","23","25"],correct:0},{q:"3 × 9 = ?",options:["26","27","28","25"],correct:1},{q:"3 × 10 = ?",options:["30","28","29","31"],correct:0}],word:[
        {q:"لديك 3 صناديق، وفي كل صندوق 3 تفاحات. كم تفاحة لديك؟", options:["8","9","10","7"], correct:1, a:3, b:3},
        {q:"اشترى خالد 4 أكياس، وفي كل كيس 3 أقلام. كم قلماً اشترى؟", options:["12","10","11","13"], correct:0, a:4, b:3},
        {q:"في الحديقة 5 أشجار، وعلى كل شجرة 3 طيور. كم طائراً في الحديقة؟", options:["14","15","16","13"], correct:1, a:5, b:3},
        {q:"لدى نورا 6 علب، وفي كل علبة 3 كرات. كم كرة لديها؟", options:["18","16","17","19"], correct:0, a:6, b:3}
      ],truefalse:[{q:"3 × 3 = 9",correct:true},{q:"3 × 5 = 16",correct:false},{q:"3 × 7 = 21",correct:true},{q:"3 × 4 = 13",correct:false},{q:"3 × 9 = 27",correct:true},{q:"3 × 6 = 17",correct:false},{q:"3 × 8 = 24",correct:true},{q:"3 × 2 = 7",correct:false},{q:"3 × 10 = 30",correct:true},{q:"3 × 1 = 4",correct:false}],matching:[{pairs:[["3 × 1","3"],["3 × 2","6"],["3 × 3","9"],["3 × 4","12"]]},{pairs:[["3 × 5","15"],["3 × 6","18"],["3 × 7","21"],["3 × 8","24"]]},{pairs:[["3 × 9","27"],["3 × 10","30"],["3 × 0","0"],["3 × 11","33"]]}]}
    };

    // ==== UI helpers ====
    const $ = s => document.querySelector(s);

    // Minimal toast helper (added)
    function toast(msg, type='ok'){
      try{
        let wrap = document.getElementById('toastWrap');
        if(!wrap){
          wrap = document.createElement('div');
          wrap.id = 'toastWrap';
          wrap.className = 'toast-wrap no-print';
          document.body.appendChild(wrap);
        }
        const el = document.createElement('div');
        el.className = 'toast ' + (type==='warn' ? 'warn' : 'ok');
        el.textContent = msg;
        wrap.appendChild(el);
        setTimeout(()=> el.classList.add('fade'), 100);
        setTimeout(()=> el.remove(), 2500);
      }catch(e){ console.log('[toast]', msg); }
    }

    function selectLevel(level){ currentLevel = level; setTextArabic('#currentLevel', level); $('#mainMenu').classList.add('hidden'); $('#gameModeSelection').classList.remove('hidden'); updateLevel1StatusRow(); window.scrollTo({top:0,behavior:'smooth'}); }
    function showGameModes(){ $('#mainMenu').classList.add('hidden'); $('#gameModeSelection').classList.remove('hidden'); $('#gameArea').classList.add('hidden'); updateLevel1StatusRow(); }
    function showMainMenu(){ $('#mainMenu').classList.remove('hidden'); $('#gameModeSelection').classList.add('hidden'); $('#gameArea').classList.add('hidden'); closeResults(); }

    function startGame(mode){
      const name = ($('#studentName').value || '').trim();
      const section = ($('#studentSection').value || '').trim();
      const teacher = ($('#teacherName').value || '').trim();
      if (!name){ toast('يرجى إدخال الاسم أولاً','warn'); $('#studentName').focus(); return; }
      playerName = name; playerSection = section; teacherName = teacher;

      currentGameMode = mode; $('#modeLabel').textContent = modeNames[mode] || mode;
      currentQuestionIndex = 0; score = 0;

      const levelQuestions = questionDatabase[currentLevel][mode];
      if (!levelQuestions || levelQuestions.length === 0){ toast('لا توجد أسئلة لهذا النمط حالياً','warn'); return; }

      if (mode === 'matching'){
        const count = Math.min(3, levelQuestions.length);
        questions = [...levelQuestions].sort(()=>Math.random()-0.5).slice(0,count);
        totalQuestions = questions.length;
        maxScorePoints = questions.reduce((sum,q)=> sum + (q.pairs?.length || 0)*10, 0);
      } else {
        const count = Math.min(10, levelQuestions.length);
        questions = [...levelQuestions].sort(()=>Math.random()-0.5).slice(0,count);
        totalQuestions = count;
        maxScorePoints = totalQuestions * 10;
      }

      $('#progressBar').style.width = '0%';
      setTextArabic('#currentQuestion', 1);
      setTextArabic('#totalQuestions', totalQuestions);
      setTextArabic('#score', 0);

      $('#gameModeSelection').classList.add('hidden');
      $('#gameArea').classList.remove('hidden');
      showQuestion(); updateProgress(); updateLevel1Pills(); window.scrollTo({top:0,behavior:'smooth'});
    }

    function updateProgress(){
      const p = ((currentQuestionIndex + 1) / totalQuestions) * 100;
      $('#progressBar').style.width = p + '%';
      setTextArabic('#currentQuestion', Math.min(currentQuestionIndex + 1, totalQuestions));
      setTextArabic('#totalQuestions', totalQuestions);
      setTextArabic('#score', score);
    }

    function withArabicDigits(text){ return toArabicDigits(text); }

    function showQuestion(){
      const q = questions[currentQuestionIndex];
      const c = $('#questionContent'); c.innerHTML=''; c.className='text-center fade-in';
      if (currentGameMode === 'basic' || currentGameMode === 'word') showMultipleChoice(q);
      else if (currentGameMode === 'truefalse') showTrueFalse(q);
      else if (currentGameMode === 'matching') showMatching(q);
    }

    function showMultipleChoice(q){
      const c = $('#questionContent');
      const qText = withArabicDigits(q.q);
      const opts = q.options.map((opt,i)=>`
        <button class="answer-btn bg-sky-100 hover:bg-sky-200 text-sky-800 py-3 px-6 rounded-lg font-semibold transition-all duration-300 hover:scale-105"
                onclick="checkAnswer(${i}, ${q.correct})">${withArabicDigits(opt)}</button>`).join('');
      c.innerHTML = `<h3 class="text-2xl font-bold text-gray-800 mb-6">${qText}</h3><div class="grid grid-cols-2 gap-4 max-w-md mx-auto">${opts}</div>`;
    }

    function showTrueFalse(q){
      $('#questionContent').innerHTML = `
        <h3 class="text-2xl font-bold text-gray-800 mb-6">${withArabicDigits(q.q)}</h3>
        <div class="flex gap-6 justify-center">
          <button class="answer-btn bg-emerald-100 hover:bg-emerald-200 text-emerald-800 py-4 px-8 rounded-lg font-semibold transition-all duration-300 hover:scale-105"
                  onclick="checkTrueFalse(true, ${q.correct})">✅ صح</button>
          <button class="answer-btn bg-rose-100 hover:bg-rose-200 text-rose-800 py-4 px-8 rounded-lg font-semibold transition-all duration-300 hover:scale-105"
                  onclick="checkTrueFalse(false, ${q.correct})">❌ خطأ</button>
        </div>`;
    }

    // Matching helpers
    let selectedLeft=null, selectedRight=null; window.matchingState={pairs:[],matches:[]};

    function showMatching(question){
      const pairs = question.pairs; window.matchingState={pairs:[...pairs],matches:[]}; selectedLeft=null; selectedRight=null;
      const left = pairs.map(p=>p[0]); const right = [...pairs.map(p=>p[1])].sort(()=>Math.random()-0.5);
      $('#questionContent').innerHTML = `
        <h3 class="text-xl font-bold text-gray-800 mb-6">اربط كل عملية ضرب بنتيجتها الصحيحة</h3>
        <div class="grid grid-cols-2 gap-8 max-w-2xl mx-auto">
          <div class="space-y-3">
            <h4 class="font-semibold text-gray-700 mb-3">العمليات</h4>
            ${left.map((item,i)=>`<button class="left-item w-full bg-sky-100 hover:bg-sky-200 text-sky-800 py-3 px-4 rounded-lg font-semibold transition-all duration-300" data-value="${item}" onclick="selectLeft(${i})">${withArabicDigits(item)}</button>`).join('')}
          </div>
          <div class="space-y-3">
            <h4 class="font-semibold text-gray-700 mb-3">النتائج</h4>
            ${right.map((item,i)=>`<button class="right-item w-full bg-emerald-100 hover:bg-emerald-200 text-emerald-800 py-3 px-4 rounded-lg font-semibold transition-all duration-300" data-value="${item}" onclick="selectRight(${i})">${withArabicDigits(item)}</button>`).join('')}
          </div>
        </div>
        <div class="mt-6">
          <button onclick="checkMatching()"
                  class="bg-purple-500 hover:bg-purple-600 text-white py-2 px-6 rounded-lg font-semibold">تحقق من الإجابات</button>
        </div>`;
    }

    function selectLeft(i){
      document.querySelectorAll('.left-item').forEach(b=>{
        if (b.disabled || b.classList.contains('matched') || b.classList.contains('hidden')) return;
        b.classList.remove('bg-sky-500','text-white');
        b.classList.add('bg-sky-100','text-sky-800');
      });
      const btn=document.querySelectorAll('.left-item')[i];
      if (btn.disabled || btn.classList.contains('matched') || btn.classList.contains('hidden')) return;
      btn.classList.remove('bg-sky-100','text-sky-800');
      btn.classList.add('bg-sky-500','text-white');
      selectedLeft=btn.dataset.value;
    }
    function selectRight(i){
      document.querySelectorAll('.right-item').forEach(b=>{
        if (b.disabled || b.classList.contains('matched') || b.classList.contains('hidden')) return;
        b.classList.remove('bg-emerald-500','text-white');
        b.classList.add('bg-emerald-100','text-emerald-800');
      });
      const btn=document.querySelectorAll('.right-item')[i];
      if (btn.disabled || btn.classList.contains('matched') || btn.classList.contains('hidden')) return;
      btn.classList.remove('bg-emerald-100','text-emerald-800');
      btn.classList.add('bg-emerald-500','text-white');
      selectedRight=btn.dataset.value;
    }

    function markMatched(sideValue, side){
      const cls = side==='left' ? '.left-item' : '.right-item';
      document.querySelectorAll(cls).forEach(b=>{
        if (b.dataset.value === sideValue){
          if (MATCH_BEHAVIOR === 'hide'){
            b.classList.add('hidden');
          } else {
            if (side==='left'){
              b.className = 'left-item w-full bg-sky-500 text-white py-3 px-4 rounded-lg font-semibold matched';
            } else {
              b.className = 'right-item w-full bg-emerald-500 text-white py-3 px-4 rounded-lg font-semibold matched';
            }
            b.style.pointerEvents = 'none';
          }
          b.disabled = true;
        }
      });
    }

    // ==== Checking answers + explanations ====
    function checkMatching(){
      if (!selectedLeft || !selectedRight){ toast('يرجى اختيار عملية ونتيجة','warn'); return; }
      const ok = window.matchingState.pairs.some(p=>p[0]===selectedLeft && p[1]===selectedRight);
      if (ok){
        score += 10; toast('إجابة صحيحة! 🎉','ok');
        markMatched(selectedLeft, 'left');
        markMatched(selectedRight, 'right');
        window.matchingState.matches.push([selectedLeft,selectedRight]);
        if (window.matchingState.matches.length === window.matchingState.pairs.length){ setTimeout(nextQuestion, 500); }
      } else {
        const m = selectedLeft.match(/(\d+)\s*×\s*(\d+)/);
        const userR = parseNumberLoose(selectedRight);
        if (m){ showExplain(parseInt(m[1],10), parseInt(m[2],10), userR, {qtext:selectedLeft}); }
        else { toast('إجابة خاطئة، حاول مرة أخرى','warn'); }
      }
      selectedLeft=null; selectedRight=null; setTextArabic('#score', score);
    }

    function extractABfromQ(q){
      if (q && typeof q.q === 'string'){
        const m = q.q.match(/(\d+)\s*×\s*(\d+)/);
        if (m) return {a:parseInt(m[1],10), b:parseInt(m[2],10), qtext:q.q};
      }
      if ('a' in q && 'b' in q) return {a:q.a, b:q.b, qtext:q.q||''};
      return null;
    }

    function checkAnswer(sel, correct){
      const btns = document.querySelectorAll('.answer-btn'); btns.forEach(b=> b.disabled=true);
      const q = questions[currentQuestionIndex];
      const ab = extractABfromQ(q);
      if (sel === correct){
        btns[sel].classList.add('bg-emerald-500','text-white','bounce'); score += 10; toast('إجابة صحيحة! 🎉','ok');
        if (ab){ showExplain(ab.a, ab.b, parseNumberLoose(btns[sel].textContent), {qtext:ab.qtext, correct:true}); }
      } else {
        btns[sel].classList.add('bg-rose-500','text-white','shake'); btns[correct].classList.add('bg-emerald-500','text-white');
        if (ab){ showExplain(ab.a, ab.b, parseNumberLoose(btns[sel].textContent), {qtext:ab.qtext}); }
      }
    }

    function checkTrueFalse(sel, correct){
      const btns = document.querySelectorAll('.answer-btn'); btns.forEach(b=> b.disabled=true);
      const q = questions[currentQuestionIndex];
      const ab = extractABfromQ(q);
      if (sel === correct){
        score += 10; toast('إجابة صحيحة! 🎉','ok');
        if (ab){ showExplain(ab.a, ab.b, null, {qtext:ab.qtext, correct:true}); }
      } else {
        if (ab){ showExplain(ab.a, ab.b, null, {qtext:ab.qtext}); }
      }
    }

    // ==== Explanation logic ====
    function showExplain(a,b,userAnswer, opts={}){
      explainOpen = true;
      const product = a * b;
      const qtext = opts.qtext || '';
      const emo = emojiFor(qtext);
      const badge = opts.correct ? 'أحسنت! لنثبت الفكرة ✨' : 'لنَفهم معًا';
      document.getElementById('explainBadge').textContent = badge;

      document.getElementById('explainText').innerHTML = `${opts.correct ? 'الإجابة صحيحة.' : 'نراجع:'} ${withArabicDigits(a+' × '+b)} يعني ${withArabicDigits(a)} مجموعات، في كل مجموعة ${withArabicDigits(b)} عناصر.`;

      const terms = Array.from({length:a}).map(()=> b);
      document.getElementById('explainSum').innerHTML = `${withArabicDigits(terms.join(' + '))} = <b class="text-sky-700">${withArabicDigits(product)}</b>`;

      let rows = '';
      for(let r=0;r<a;r++){ rows += `<div class="emoji-row">` + Array.from({length:b}).map(()=> `<span class="emoji">${emo}</span>`).join('') + `</div>`; }
      document.getElementById('explainEmoji').innerHTML = rows;

      const cell = 22, pad = 8; const W = b*cell + pad*2, H = a*cell + pad*2;
      let rects = ''; for(let r=0;r<a;r++){ for(let c=0;c<b;c++){ rects += `<rect x="${pad + c*cell+2}" y="${pad + r*cell+2}" width="${cell-4}" height="${cell-4}" rx="4" ry="4" fill="rgba(14,165,233,.25)" stroke="rgba(14,165,233,.7)"/>`; } }
      document.getElementById('explainSVG').innerHTML = `<svg width="${Math.max(W,220)}" height="${Math.max(H,120)}" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg"><rect x="1" y="1" width="${W-2}" height="${H-2}" rx="10" ry="10" fill="white" stroke="#e5e7eb"/>${rects}</svg>`;

      const userStr = (userAnswer!=null) ? `إجابتك كانت ${withArabicDigits(userAnswer)}، ` : '';
      document.getElementById('explainFooter').innerHTML = `${userStr}والصحيح هو <b class="text-emerald-700">${withArabicDigits(product)}</b>. عدّ المربعات أو الرموز للتأكد.`;

      document.getElementById('explainOverlay').style.display = 'flex';
    }
    function goNextFromExplain(){ if (!explainOpen) return; closeExplain(); nextQuestion(); }
    function closeExplain(){ document.getElementById('explainOverlay').style.display = 'none'; explainOpen = false; }

    // ==== Next / Results + Certificate gating ====
    function nextQuestion(){ currentQuestionIndex++; if (currentQuestionIndex >= totalQuestions){ showResults(); } else { updateProgress(); showQuestion(); } }

    function showResults(){
      // Mark completion for certificate if level 1
      markCompleted(playerName, String(currentLevel), currentGameMode);

      const pct = maxScorePoints ? Math.round((score/maxScorePoints)*100) : 0;
      let icon, title, msg; if (pct>=80){icon="🏆";title="ممتاز!";msg="أداء رائع! لقد أتقنت التمرين";} else if (pct>=60){icon="⭐";title="جيد جداً!";msg="عمل جميل، واصل التدريب";} else {icon="💪";title="حاول مرة أخرى";msg="تحتاج لمزيد من التدريب";}
      document.getElementById('resultIcon').textContent=icon; document.getElementById('resultTitle').textContent=title; document.getElementById('resultMessage').textContent=msg;
      setTextArabic('#finalScore', score); setTextArabic('#maxScore', maxScorePoints);

      // Certificate gating
      const eligible = (currentLevel === 1) && isEligibleForCert(playerName);
      const hintEl = document.getElementById('certHint');
      const btn = document.getElementById('certBtn');
      if (eligible){
        hintEl.textContent = 'تهانينا! أكملت جميع أنماط المستوى ١. يمكنك طباعة شهادة الإنجاز.';
        btn.classList.remove('hidden');
      } else if (currentLevel === 1){
        const need = missingModes(playerName);
        hintEl.textContent = 'لطباعة شهادة إنجاز المستوى ١: أكمِل الأنماط المتبقية — ' + need.join('، ');
        btn.classList.add('hidden');
      } else {
        hintEl.textContent = 'شهادة الإنجاز مخصصة لإكمال جميع أنماط المستوى ١.';
        btn.classList.add('hidden');
      }

      updateLevel1StatusRow();
      updateLevel1Pills();
      document.getElementById('resultsModal').classList.remove('hidden');
    }
    function restartGame(){ closeResults(); startGame(currentGameMode); }
    function closeResults(){ document.getElementById('resultsModal').classList.add('hidden'); }

    // Level 1 status UI
    function updateLevel1StatusRow(){
      const cont = document.getElementById('level1Status');
      if (!cont) return;
      const l1 = (completions[playerName||'']||{})['1'] || {};
      cont.innerHTML = `حالة شهادة المستوى ١: 
        <span class="pill ${l1.basic?'ok':'no'}">أساسية ${l1.basic?'✓':'✗'}</span>
        <span class="pill ${l1.word?'ok':'no'}">لفظية ${l1.word?'✓':'✗'}</span>
        <span class="pill ${l1.truefalse?'ok':'no'}">صح/خطأ ${l1.truefalse?'✓':'✗'}</span>
        <span class="pill ${l1.matching?'ok':'no'}">مطابقة ${l1.matching?'✓':'✗'}</span>`;
    }
    function updateLevel1Pills(){
      const el = document.getElementById('level1Pills'); if (!el) return;
      const l1 = (completions[playerName||'']||{})['1'] || {};
      el.innerHTML = `شهادة ١: 
        <span class="pill ${l1.basic?'ok':'no'}">أساسية ${l1.basic?'✓':'✗'}</span>
        <span class="pill ${l1.word?'ok':'no'}">لفظية ${l1.word?'✓':'✗'}</span>
        <span class="pill ${l1.truefalse?'ok':'no'}">صح/خطأ ${l1.truefalse?'✓':'✗'}</span>
        <span class="pill ${l1.matching?'ok':'no'}">مطابقة ${l1.matching?'✓':'✗'}</span>`;
    }

    // ==== Certificate ====
    function openCertificate(fromResults=false){
      // If not eligible, do nothing
      const eligible = isEligibleForCert(playerName);
      if (!eligible){ toast('للحصول على الشهادة: أكمل جميع أنماط المستوى ١.', 'warn'); return; }

      document.getElementById('certName').textContent = playerName || '—';
      const sec = playerSection ? ` (شعبة ${playerSection})` : '';
      // Reason for full completion
      document.getElementById('certReason').textContent = `لإكماله/ـا جميع تمارين المستوى ${withArabicDigits(1)} — الأنماط: أساسية، لفظية، صح/خطأ، مطابقة.`;
      setTextArabic('#cLevel', 1);
      document.getElementById('cMode').textContent = 'جميع الأنماط';
      document.getElementById('cScore').textContent = 'مكتمل';
      document.getElementById('cDate').textContent = toArabicDigits(new Date().toLocaleDateString('ar-SA'));
      document.getElementById('cSerial').textContent = toArabicDigits(genSerial());
      document.getElementById('cTeacher').textContent = teacherName ? `المعلم/المعلمة: ${teacherName}` : 'المعلم/المعلمة';
      document.getElementById('certOverlay').style.display = 'flex';
    }
    function closeCertificate(){ document.getElementById('certOverlay').style.display = 'none'; }
    function genSerial(){ const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `MTABLE-${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}-${Math.random().toString(36).slice(2,6).toUpperCase()}`; }
  </script>
</body>
</html>
